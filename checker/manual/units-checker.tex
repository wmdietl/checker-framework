\htmlhr
\chapter{Units Checker\label{units-checker}}

For many applications, it is important to use the correct units of
measurement for primitive types.  For example, NASA's Mars Climate Orbiter
(cost: \$327 million) was lost because of a discrepancy between use
of the metric unit Newtons and the imperial measure Pound-force.

The \emph{Units Checker} ensures consistent usage of units.
For example, consider the following code:

\begin{alltt}
@m int meters = 5 * UnitsTools.m;
@s int secs = 2 * UnitsTools.s;
@mPERs int speed = meters / secs;
\end{alltt}

Due to the annotations \<@m> and \<@s>, the variables \code{meters} and
\code{secs} are guaranteed to contain only values with meters and seconds
as units of measurement.

Utility class \code{UnitsTools} provides constants with which
unqualified number literals are multiplied to get values of the corresponding unit.
The assignment of an unqualified value to \code{meters}, as in
\code{meters = 99}, will be flagged as an error by the Units Checker.

The division \code{meters/secs} takes the types of the two operands
into account and determines that the result is of type
meters per second, signified by the \code{@mPERs} qualifier.

We provide an extensible framework to define the result of operations
on units.

\section{Units annotations\label{units-annotations}}

The checker currently supports three varieties of units annotations: kind annotations, SI units, and special annotations.

Kind annotations can be used to declare what the expected unit of
measurement is, without fixing the particular unit used.
For example, one could write a method taking a \code{@Length} value,
without specifying whether it will take meters or kilometers.
The following kind annotations are defined:

\begin{description}
\item[\refqualclass{checker/units/qual}{Acceleration}]

\item[\refqualclass{checker/units/qual}{Angle}]

\item[\refqualclass{checker/units/qual}{Area}]

\item[\refqualclass{checker/units/qual}{Current}]

\item[\refqualclass{checker/units/qual}{Length}]

\item[\refqualclass{checker/units/qual}{Luminance}]

\item[\refqualclass{checker/units/qual}{Mass}]

\item[\refqualclass{checker/units/qual}{Speed}]

\item[\refqualclass{checker/units/qual}{Substance}]

\item[\refqualclass{checker/units/qual}{Temperature}]

\item[\refqualclass{checker/units/qual/time/duration}{TimeDuration}]
  which represents a length on a time scale, or simply the elapsed time between two events. For example, 5 hours, 3 months, or 12 years.

\item[\refqualclass{checker/units/qual/time/point}{TimePoint}]
  which represents a point on a time scale relative to some reference point denoted as zero point of this time scale, or simply the precise time at which some event occurs.
  For example, 5am (relative to midnight), March (relative to beginning of a year), or 2012 (relative to 0 BCE).

\item[\refqualclass{checker/units/qual}{Volume}]
\end{description}


For each kind of unit, the corresponding SI unit of
measurement is defined:

\begin{enumerate}
\item For \code{@Acceleration}:

  Meter Per Second Square \refqualclass{checker/units/qual}{mPERs2}

\item For \code{@Angle}:

  Radians \refqualclass{checker/units/qual}{radians},
  and the derived unit

  Degrees \refqualclass{checker/units/qual}{degrees}

\item For \code{@Area}:

  the derived units

  square millimeters \refqualclass{checker/units/qual}{mm2},

  square meters \refqualclass{checker/units/qual}{m2}, and

  square kilometers \refqualclass{checker/units/qual}{km2}

\item For \code{@Current}:

  Ampere \refqualclass{checker/units/qual}{A}

\item For \code{@Length}:

  Meters \refqualclass{checker/units/qual}{m},
  and the derived units

  millimeters \refqualclass{checker/units/qual}{mm}, and

  kilometers \refqualclass{checker/units/qual}{km}

\item For \code{@Luminance}:

  Candela \refqualclass{checker/units/qual}{cd}

\item For \code{@Mass}:

  kilograms \refqualclass{checker/units/qual}{kg},
  and the derived unit

  grams \refqualclass{checker/units/qual}{g}

\item For \code{@Speed}:

  meters per second \refqualclass{checker/units/qual}{mPERs}, and

  kilometers per hour \refqualclass{checker/units/qual}{kmPERh}

\item For \code{@Substance}:

  Mole \refqualclass{checker/units/qual}{mol}

\item For \code{@Temperature}:

  Kelvin \refqualclass{checker/units/qual}{K},
  and the derived unit

  Celsius \refqualclass{checker/units/qual}{C}

\item For \code{@TimeDuration}:

  seconds \refqualclass{checker/units/qual/time/duration}{s},
  and the derived units

  nanoseconds \refqualclass{checker/units/qual/time/duration}{ns},

  microseconds \refqualclass{checker/units/qual/time/duration}{us},

  milliseconds \refqualclass{checker/units/qual/time/duration}{ms},

  minutes \refqualclass{checker/units/qual/time/duration}{min},

  hours \refqualclass{checker/units/qual/time/duration}{h},

  half-days \refqualclass{checker/units/qual/time/duration}{halfday},

  days \refqualclass{checker/units/qual/time/duration}{day},

  weeks \refqualclass{checker/units/qual/time/duration}{week},

  months \refqualclass{checker/units/qual/time/duration}{month},

  quarter-years \refqualclass{checker/units/qual/time/duration}{quarteryear},

  years \refqualclass{checker/units/qual/time/duration}{year},

  decades \refqualclass{checker/units/qual/time/duration}{decade},

  centuries \refqualclass{checker/units/qual/time/duration}{century},

  millennia \refqualclass{checker/units/qual/time/duration}{millennia},

  era \refqualclass{checker/units/qual/time/duration}{era},

  as well as an artificially defined conceptual unit of
  forever \refqualclass{checker/units/qual/time/duration}{forever}

\item For \code{@TimePoint}:

  the units

  calendar seconds \refqualclass{checker/units/qual/time/point}{CALs},

  calendar nanoseconds \refqualclass{checker/units/qual/time/point}{CALns},

  calendar microseconds \refqualclass{checker/units/qual/time/point}{CALus},

  calendar milliseconds \refqualclass{checker/units/qual/time/point}{CALms},

  calendar minutes \refqualclass{checker/units/qual/time/point}{CALmin},

  calendar hours \refqualclass{checker/units/qual/time/point}{CALh},

  calendar half-days \refqualclass{checker/units/qual/time/point}{CALhalfday},

  calendar days \refqualclass{checker/units/qual/time/point}{CALday},

  calendar weeks \refqualclass{checker/units/qual/time/point}{CALweek},

  calendar months \refqualclass{checker/units/qual/time/point}{CALmonth},

  calendar quarter-years \refqualclass{checker/units/qual/time/point}{CALquarteryear},

  calendar years \refqualclass{checker/units/qual/time/point}{CALyear},

  calendar decades \refqualclass{checker/units/qual/time/point}{CALdecade},

  calendar centuries \refqualclass{checker/units/qual/time/point}{CALcentury},

  calendar millennia \refqualclass{checker/units/qual/time/point}{CALmillennia},

  calendar era \refqualclass{checker/units/qual/time/point}{CALera},

  as well as an artificially defined conceptual unit of
  calendar forever \refqualclass{checker/units/qual/time/point}{CALforever}

\item For \code{@Volume}:

  the derived units

  meters cubed \refqualclass{checker/units/qual}{m3},

  millimeters cubed \refqualclass{checker/units/qual}{mm3}, and

  kilometers cubed \refqualclass{checker/units/qual}{km3}

\end{enumerate}


There are 4 special annotations:
\begin{enumerate}
\item \refqualclass{checker/units/qual}{Scalar}
  Which represents unitless scalars in scientific computation such as the special
  values \code{pi} and \code{e}, and is the annotation for programming constructs
  that do not have any units at all such as Strings. \code{@Scalar} is the
  default type for the units checker type hierarchy, and it is also the default
  unit for implicit and explicit upper bounds in type parameters.

\item \refqualclass{checker/units/qual}{UnitsBottom}
  which is the annotation of the \code{null} literal and the Void class. It is
  the bottom type of the units checker type hierarchy, and is also the default
  unit for implicit lower bounds in type parameters.

\item \refqualclass{checker/units/qual}{UnknownUnits}
  which is the default annotation of local variables, exceptions, and resource
  variables. It is the top type of the units checker type hierarchy.
  As the default annotation of local variables, any local variable can have its
  unit adapted through a data-flow sensitive type qualifier inference process.
  For example:

\begin{alltt}
@Length int method(int y) \{
  int x;                   // x is initially an UnknownUnit
  if (y > 10) \{
    x = 5 * UnitsTools.m;  // x becomes a meter
  \} else \{
    x = 9 * UnitsTools.km; // x becomes a kilometer here
  \}
  // data-flow analysis computes the smallest generalization
  // possible between the two units, which is Length.
  return x;                // x becomes simply a length here
\}
\end{alltt}

See \ref{type-refinement} for more information about flow-sensitive type qualifier inference.

\item \refqualclass{checker/units/qual}{PolyUnit}
  which is the polymorphic annotation for the units checker. This annotation
  enables you to write a method that takes an argument of any unit type and
  returns a result of that same type. For more about polymorphic qualifiers,
  see Section~\ref{qualifier-polymorphism}. For an example of it use, see
  \code{@PolyUnit}, see the
  \href{api/org/checkerframework/checker/units/qual/PolyUnit.html}{\<@PolyUnit>} Javadoc.

\end{enumerate}

You may specify SI unit prefixes, using enumeration \code{\refclass{checker/units/qual}{Prefix}}.
The basic SI units
(\code{@s}, \code{@m}, \code{@g}, \code{@A}, \code{@K},
 \code{@mol}, \code{@cd})
take an optional \code{Prefix} enum as argument.
For example, to use nanoseconds as unit, you could use
\code{@s(Prefix.nano)} as a unit type or use the provided \code{@ns}.
The two are interchangeable.

Class \code{UnitsTools} contains a constant for each SI unit.
To create a value of the particular unit, multiply an unqualified
value with one of these constants.
By using static imports, this allows very natural notation; for
example, after statically importing \code{UnitsTools.m},
the expression \code{5 * m} represents five meters.
As all these unit constants are public, static, and final with value
one, the compiler will optimize away these multiplications.



\section{Extending the Units Checker\label{extending-units}}

You can create new kind annotations and unit annotations that are specific
to the particular needs of your project.  An easy way to do this is by
copying and adapting an existing annotation.  (In addition, search for all
uses of the annotation's name throughout the Units Checker implementation,
to find other code to adapt; read on for details.)

Here is an example of a new unit annotation.

\begin{alltt}
@Documented
@Retention(RetentionPolicy.RUNTIME)
@SubtypeOf( \ttlcb{} Length.class \ttrcb{} )
@UnitsMultiple(quantity=m.class, prefix=Prefix.nano)
@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
public @interface nm \ttlcb{}\ttrcb{}
\end{alltt}

The \code{@SubtypeOf} meta-annotation specifies that this annotation
introduces an additional unit of time.
The \code{@UnitsMultiple} meta-annotation specifies that this annotation
should be a nano multiple of the basic unit \code{@m}:  \code{@nm} and
\code{@m(Prefix.nano)} behave equivalently and interchangeably.
Most annotation definitions do not have a \<@UnitsMultiple> meta-annotation.

Note that all custom annotations must have the
\<@Target({ElementType.TYPE\_USE})> meta-annotation. See section
\ref{define-type-qualifiers}.

To take full advantage of the additional unit qualifier, you need to
do two additional steps.
(1)~Provide constants that convert from unqualified types to types that use
the new unit.
See class \code{UnitsTools} for examples (you will need to suppress a
checker warning in just those few locations).
(2)~Put the new unit in relation to existing units.
Provide an
implementation of the \code{UnitsRelations} interface as a
meta-annotation to one of the units.

See demonstration \code{examples/units-extension/} for an example
extension that defines Hertz (hz) as scalar per second, and defines an
implementation of \code{UnitsRelations} to enforce it.



\section{What the Units Checker checks\label{units-checks}}



The Units Checker ensures that unrelated types are not mixed.

All types with a particular unit annotation are
disjoint from all unannotated types, from all types with a different unit
annotation, and from all types with the same unit annotation but a
different prefix.

Subtyping between the units and the unit kinds is taken into account,
as is the \code{@UnitsMultiple} meta-annotation.

Three categories of rules are enforced: arithmetic, compound assignment,
and comparison rules.

\begin{itemize}
\item
Arithmetic rules:

Time durations and time points have a special logic between them.

The definition of a duration is the differece between two time points, thus
the subtraction of one time point to another results in a duration.
For example 10 am - 5 am = 5 hours.

By the same logic, adding a time duration to a time point results in a time
point. For example 2015 + 5 years = 2020.

The addition, multiplication, division, and modulo of two time points is
scientifically undefined, and is disallowed by the checker.

The rules for arithmetic operations between two duration units is the same as
all other units in the units checker, as follows:

Addition and subtraction is allowed between two variables or values of
the same unit type.

Multiplying a scalar with a unit type results in the same unit type.

The division of a unit type by the same unit type results in a scalar.

Multiplying or dividing different unit types, for which no unit
relation is known to the system, will result in a \code{UnknownUnits}
type.
If you encounter a \code{UnknownUnits} annotation in an error message,
ensure that your operations are performed on correct units or refine
your \code{UnitsRelations} implementation.

The modulo of a unit type with any other type keeps its unit, as the remainder
of a division always has the same unit as the dividend.

The Units Checker does \emph{not} change units based on multiplication or
division; for example, if variable \<mass> has the type \<@kg double>, then
\<mass * 1000> has that same type rather than the type \<@g double>. (The
Units Checker has no way of knowing whether you intended a conversion, or you
were computing the mass of 1000 items.  You need to make all conversions
explicit in your code, and it's good style to minimize the number of
conversions.)

\item
Compound Assignment rules:

For \code{+=} and \code{-=}, the right hand expression must have a unit that
is a subtype of the left hand variable. For example \code{length += meter}
would pass but \code{seconds += grams} will not.

For \code{*=} and \code{/=}, if the left hand variable has the unit
\code{@UnknownUnits}, then regardless of what the right hand expression's unit
is, the variable stays as \code{@UnknownUnits}. If the left hand variable has
some other unit and the right hand expression has the unit scalar, then the
variable keeps its unit. Any other units combinations is disallowed.

For \code{\%=}, the left hand variable keeps its unit regardless of what the
right hand expression's unit is.

\item
Comparison rules:

For all comparison operations, units checker permits comparisons between two
variables or values with identical units, as well as comparisons between any
unit with a scalar, or with a null literal.

Comparisons between a unit and a scalar is conceptually understood as a
comparison of the scalar magnitude of the unit with the scalar.

Comparisons with null literals are of course permitted due to the need to
check for null references on objects.
\end{itemize}


\section{Running the Units Checker\label{units-running}}

The Units Checker can be invoked by running the following commands.

\begin{itemize}
\item
If your code uses only the SI units that are provided by the
framework, simply invoke the checker:

\begin{Verbatim}
  javac -processor org.checkerframework.checker.units.UnitsChecker MyFile.java ...
\end{Verbatim}

\item
If you define your own units, provide the fully-qualified class names of the
annotations through the \code{-Aunits} option, using a comma-no-space-separated
notation:

\begin{alltt}
  javac -Xbootclasspath/p:\textit{/full/path/to/myProject/bin}:\textit{/full/path/to/myLibrary/bin} \ttbs
        -processor org.checkerframework.checker.units.UnitsChecker \ttbs
        -Aunits=\textit{myModule.qual.MyUnit},\textit{myModule.qual.MyOtherUnit} MyFile.java ...
\end{alltt}

The annotations listed in \code{-Aunits} must be accessible to
the compiler during compilation in the classpath.  In other words, they must
already be compiled (and, typically, be on the javac bootclasspath)
before you run the Units Checker with \code{javac}.  It
is not sufficient to supply their source files on the command line.

\item
You can also provide the fully-qualified paths to a set of directories
that contain units qualifiers through the \code{-AunitsDirs} option,
using a colon-no-space-separated notation. For example:

\begin{alltt}
  javac -Xbootclasspath/p:\textit{/full/path/to/myProject/bin}:\textit{/full/path/to/myLibrary/bin} \ttbs
        -processor org.checkerframework.checker.units.UnitsChecker \ttbs
        -AunitsDirs=\textit{/full/path/to/myProject/bin}:\textit{/full/path/to/myLibrary/bin} MyFile.java ...
\end{alltt}

Note that in these two examples, the compiled class file of the
\<myModule.qual.MyUnit> and \<myModule.qual.MyOtherUnit> annotations
must exist in either the \<myProject/bin> directory or the
\<myLibrary/bin> directory. The following placement of the class files
will work with the above commands:

\begin{alltt}
  .../myProject/bin/myModule/qual/MyUnit.class
  .../myProject/bin/myModule/qual/MyOtherUnit.class
\end{alltt}

The two options can be used at the same time to provide groups of annotations
from directories, and individually named annotations.

\end{itemize}

Also, see the example project in the \<checker/examples/units-extension> directory.



\section{Suppressing warnings\label{units-suppressing}}

One example of when you need to suppress warnings is when you initialize a
variable with a unit type by a literal value. To remove this warning message,
it is best to introduce a constant that represents the unit and to add a
\code{@SuppressWarnings} annotation to that constant.
For examples, see class \code{UnitsTools}.



\section{References\label{units-references}}

\begin{itemize}
\item The GNU Units tool provides a comprehensive list of units:\\
  \url{http://www.gnu.org/software/units/}

\item The F\# units of measurement system inspired some of our syntax:\\
  \url{https://en.wikibooks.org/wiki/F_Sharp_Programming/Units_of_Measure}

\end{itemize}

% LocalWords:  UnitsTools toMeter toSecond mPERs Candela cd kmPERh mol nano ns
% LocalWords:  milli RetentionPolicy SubtypeOf UnitsMultiple hz PolyUnit
% LocalWords:  UnitsRelations Aunits MyFile mm2 m2 km2 enum ElementType
%  LocalWords:  MixedUnits java mPERs2 api classpath bootclasspath
%%  LocalWords:  AunitsDirs myProject myLibrary
